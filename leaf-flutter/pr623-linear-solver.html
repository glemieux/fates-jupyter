

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Linear least squares solver technote &mdash; FATES development notebooks</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/mystnb.css" type="text/css" />
  <link rel="stylesheet" href="../_static/sphinx-thebe.css" type="text/css" />
  <link rel="stylesheet" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
  <link rel="stylesheet" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/togglebutton.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
        <script src="../_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
        <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
        <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
        <script async="async" src="../_static/sphinx-thebe.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Deciduous test analysis" href="deciduous/README.html" />
    <link rel="prev" title="Issue 383 Optimum LAI versus trim increment" href="issue383-optimum-clai-trim-fraction.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../README.html">
          

          
            
            <img src="../_static/ngeet.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">California</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../california/README.html">California FATES development</a></li>
</ul>
<p class="caption"><span class="caption-text">Fragmentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../fragmentation/README.html">FATES-HLM fragmentation scalar implementation</a></li>
</ul>
<p class="caption"><span class="caption-text">fates_main_api</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../fates_main_api/README.html">fates_main_api notebooks</a></li>
</ul>
<p class="caption"><span class="caption-text">Leaf Flutter</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="README.html">Issue 383 study</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="issue383-optimum-clai-trim-fraction.html">Issue 383 Optimum LAI versus trim increment</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Linear least squares solver technote</a></li>
<li class="toctree-l2"><a class="reference internal" href="deciduous/README.html">Deciduous test analysis</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../README.html">Python</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../README.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="README.html">Issue 383 study</a> &raquo;</li>
        
      <li>Linear least squares solver technote</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/leaf-flutter/pr623-linear-solver.ipynb" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="linear-least-squares-solver-technote">
<h1>Linear least squares solver technote<a class="headerlink" href="#linear-least-squares-solver-technote" title="Permalink to this headline">¶</a></h1>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li><p><a class="reference external" href="http://www.personal.psu.edu/jhm/f90/lectures/lsq1.html">http://www.personal.psu.edu/jhm/f90/lectures/lsq1.html</a></p></li>
<li><p>Boyd, S. and Vandenberghe, L., <u>Introduction to Applied Linear Algebra</u>, ppg 245 - 250, <a class="reference external" href="https://web.stanford.edu/~boyd/vmls/vmls.pdf">https://web.stanford.edu/~boyd/vmls/vmls.pdf</a></p></li>
<li><p>LAPACK User’s Guide, Third Edition, <a class="reference external" href="http://www.netlib.org/lapack/lug/">http://www.netlib.org/lapack/lug/</a></p></li>
</ol>
</div>
<div class="section" id="linear-system-setup">
<h2>Linear system setup<a class="headerlink" href="#linear-system-setup" title="Permalink to this headline">¶</a></h2>
<p>We wish to fit a straight line to the data point set <span class="math notranslate nohighlight">\((x_i,y_i)\)</span>:
$<span class="math notranslate nohighlight">\(y_i = mx_i + b\)</span><span class="math notranslate nohighlight">\(
where \)</span>x<span class="math notranslate nohighlight">\( is the the `currentCohort%year_net_uptake(z)` minus the `currentCohort%leaf_cost` and and \)</span>y<span class="math notranslate nohighlight">\( is the `cumulative_lai` for the cohort to the given leaf layer \)</span>i<span class="math notranslate nohighlight">\( (denoted as `z` in the code).  Our goal is to determine the \)</span>y<span class="math notranslate nohighlight">\(-intercept, \)</span>b<span class="math notranslate nohighlight">\(, to determine what the theoretical &quot;optimitial LAI&quot; is that balances out the leaf layer uptake after costs (i.e. where \)</span>x=0<span class="math notranslate nohighlight">\().  We can model this data as a linear system:
\)</span><span class="math notranslate nohighlight">\(\vec{y} = \mathbf{A}\vec{z}\)</span><span class="math notranslate nohighlight">\(
where:
\)</span><span class="math notranslate nohighlight">\(\vec{y} = \begin{bmatrix} y_1 \\ y_2 \\ \vdots \\ y_N \end{bmatrix}, \quad \mathbf{A} = \begin{bmatrix} 1 &amp; x_1 \\ 1 &amp; x_2 \\ \vdots &amp; \vdots \\ 1 &amp; x_N \end{bmatrix}, \quad \vec{z} = \begin{bmatrix} b \\ m \end{bmatrix} \)</span><span class="math notranslate nohighlight">\(
Here \)</span>\vec{z}<span class="math notranslate nohighlight">\( is our solution vector consisting of the slope and intercept of our linear fit function.  To determine the best fit to the set of data points, we need to minimize the residual, \)</span>\Vert r \Vert^2<span class="math notranslate nohighlight">\(:
\)</span><span class="math notranslate nohighlight">\(\Vert r \Vert^2 = \Vert \mathbf{A}\vec{z} - \vec{y} \Vert^2\)</span><span class="math notranslate nohighlight">\(
We arrange in this form for the `dgels` LAPACK solver:
\)</span><span class="math notranslate nohighlight">\(\left(\mathbf{A}^T\mathbf{A} \right)\vec{z} = \mathbf{A}^T\vec{y}\)</span><span class="math notranslate nohighlight">\(
which expands to:
\)</span><span class="math notranslate nohighlight">\( \begin{bmatrix} N &amp; \sum_{i=1}^N{x_i} \\ \sum_{i=1}^N{x_i} &amp; \sum_{i=1}^N{x_i}^2  \end{bmatrix} \begin{bmatrix} b \\ m \end{bmatrix} =  \begin{bmatrix} \sum_{i=1}^N{y_i} \\ \sum_{i=1}^N{x_i}{y_i}  \end{bmatrix}\)</span>$</p>
</div>
<div class="section" id="translation-to-code">
<h2>Translation to code<a class="headerlink" href="#translation-to-code" title="Permalink to this headline">¶</a></h2>
<p>Given that we are retaining the code that loops through each leaf layer to maintain the original cohort method for leaf layers of less than some hardcoded minimun number (given as <code class="docutils literal notranslate"><span class="pre">nll</span></code> in the code), we can accumulate the sums and products of linear system matrices on the fly as opposed to saving off the <span class="math notranslate nohighlight">\(\vec{x}\)</span> and <span class="math notranslate nohighlight">\(\vec{y}\)</span> vectors using the following form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>nnu_clai_a(1,1) = nnu_clai_a(1,1) + 1 ! Increment for each layer used
nnu_clai_a(1,2) = nnu_clai_a(1,2) + currentCohort%year_net_uptake(z) - currentCohort%leaf_cost
nnu_clai_a(2,1) = nnu_clai_a(1,2)
nnu_clai_a(2,2) = nnu_clai_a(2,2) + (currentCohort%year_net_uptake(z) - currentCohort%leaf_cost)**2
nnu_clai_b(1,1) = nnu_clai_b(1,1) + cumulative_lai
nnu_clai_b(2,1) = nnu_clai_b(2,1) + (cumulative_lai * &amp; 
                (currentCohort%year_net_uptake(z) - currentCohort%leaf_cost))
</pre></div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "julia-1.4"
        },
        kernelOptions: {
            kernelName: "julia-1.4",
            path: "./leaf-flutter"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'julia-1.4'</script>

           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="deciduous/README.html" class="btn btn-neutral float-right" title="Deciduous test analysis" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="issue383-optimum-clai-trim-fraction.html" class="btn btn-neutral float-left" title="Issue 383 Optimum LAI versus trim increment" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>